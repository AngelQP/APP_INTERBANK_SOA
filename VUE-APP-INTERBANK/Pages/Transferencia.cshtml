@page
@{
    ViewData["Title"] = "Transferencias";
}

<div id="app" class="container mt-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-secondary">Transferencias (Modo Prueba)</h2>

        <button v-if="servicioActual !== ''"
                class="btn btn-outline-primary btn-sm"
                v-on:click="volverAlMenu">
            <i class="fa fa-arrow-left"></i> Volver a Servicios
        </button>
    </div>

    <!-- MENU PRINCIPAL -->
    <div v-if="servicioActual === ''">
        <div class="row">
            <div class="col-md-12 mb-3">
                <p class="lead">Seleccione el servicio que desea probar:</p>
            </div>

            <!-- REALIZAR TRANSFERENCIA -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm btn-card h-100"
                     v-on:click="seleccionarServicio('REALIZAR_TRANSFERENCIA')">
                    <div class="card-body text-center">
                        <h3 class="text-success"><i class="fa fa-exchange-alt"></i></h3>
                        <h5 class="card-title">1. Realizar Transferencia</h5>
                        <p class="text-muted small">POST | IN: idUsuarioOrigen, idUsuarioDestino, monto | OUT: Código / Mensaje</p>
                    </div>
                </div>
            </div>

            <!-- HISTORIAL -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm btn-card h-100"
                     v-on:click="seleccionarServicio('HISTORIAL_TRANSFERENCIAS')">
                    <div class="card-body text-center">
                        <h3 class="text-info"><i class="fa fa-list"></i></h3>
                        <h5 class="card-title">2. Historial de Transferencias</h5>
                        <p class="text-muted small">GET | IN: idUsuario, fecha, monto | OUT: Lista</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SERVICIO 1: REALIZAR TRANSFERENCIA -->
    <div v-if="servicioActual === 'REALIZAR_TRANSFERENCIA'">
        <h4 class="mb-3 text-success">Realizar Transferencia</h4>

        <div class="card p-3">
            <p class="text-muted"><strong>IN:</strong> Datos de la Transferencia</p>

            <form v-on:submit.prevent="ejecutarTransferencia">
                <div class="form-row">

                    <div class="col-md-4 mb-3">
                        <label>ID Usuario Origen</label>
                        <input type="number" class="form-control"
                               v-model="formTransfer.idUsuarioOrigen" required>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label>ID Usuario Destino</label>
                        <input type="number" class="form-control"
                               v-model="formTransfer.idUsuarioDestino" required>
                    </div>

                    <div class="col-md-4 mb-3">
                        <label>Monto</label>
                        <input type="number" step="0.01" class="form-control"
                               v-model="formTransfer.monto" required>
                    </div>

                </div>

                <button class="btn btn-success btn-block">Transferir</button>
            </form>
        </div>

        <div class="card border-success mt-3" v-if="resultadoTransferencia">
            <div class="card-header">Resultado OUT:</div>
            <div class="card-body">
                <p><strong>Código Operación:</strong> {{ resultadoTransferencia.codigoOperacion }}</p>
                <p><strong>Estado:</strong> {{ resultadoTransferencia.estado }}</p>
                <p><strong>Mensaje:</strong> {{ resultadoTransferencia.mensaje }}</p>
            </div>
        </div>
    </div>

    <!-- SERVICIO 2: HISTORIAL -->
    <div v-if="servicioActual === 'HISTORIAL_TRANSFERENCIAS'">
        <h4 class="mb-3 text-info">Historial de Transferencias</h4>

        <div class="card p-3 bg-light mb-3">
            <p class="text-muted"><strong>Filtros IN:</strong></p>

            <div class="form-row">

                <div class="col-md-4 mb-3">
                    <label>ID Usuario (obligatorio)</label>
                    <input type="number" class="form-control"
                           v-model="inputs.idUsuarioHistorial" required>
                </div>

                <div class="col-md-4 mb-3">
                    <label>Fecha</label>
                    <input type="date" class="form-control"
                           v-model="inputs.fechaHistorial">
                </div>

                <div class="col-md-4 mb-3">
                    <label>Monto</label>
                    <input type="number" step="0.01" class="form-control"
                           v-model="inputs.montoHistorial">
                </div>

            </div>

            <button class="btn btn-info btn-block"
                    v-on:click="ejecutarHistorial">
                Consultar Historial
            </button>
        </div>

        <table class="table table-bordered table-hover" v-if="listaHistorial.length > 0">
            <thead class="thead-light">
                <tr>
                    <th>ID Operación</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Monto</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="h in listaHistorial">
                    <td>{{ h.idOperacion }}</td>
                    <td>{{ h.usuarioOrigen }}</td>
                    <td>{{ h.usuarioDestino }}</td>
                    <td>{{ h.monto }}</td>
                    <td>{{ h.fecha }}</td>
                    <td>{{ h.estado }}</td>
                </tr>
            </tbody>
        </table>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.3"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Archivo API -->
<script src="~/js/api/transferencia.js"></script>

<style>
    .btn-card {
        cursor: pointer;
        transition: 0.2s;
        border: 1px solid #ddd;
    }

        .btn-card:hover {
            transform: translateY(-3px);
            background-color: #f8f9fa;
            border-color: #007bff;
        }
</style>

<script>
    new Vue({
        el: "#app",
        data: {
            servicioActual: "",

            resultadoTransferencia: null,
            listaHistorial: [],

            formTransfer: {
                idUsuarioOrigen: null,
                idUsuarioDestino: null,
                monto: null
            },

            inputs: {
                idUsuarioHistorial: null,
                fechaHistorial: null,
                montoHistorial: null
            }
        },

        methods: {
            seleccionarServicio(servicio) {
                this.servicioActual = servicio;
                this.limpiarDatos();
            },
            volverAlMenu() {
                this.servicioActual = "";
                this.limpiarDatos();
            },
            limpiarDatos() {
                this.resultadoTransferencia = null;
                this.listaHistorial = [];
            },

            // 1) Realizar transferencia
            ejecutarTransferencia() {
                if (!this.formTransfer.idUsuarioOrigen ||
                    !this.formTransfer.idUsuarioDestino ||
                    !this.formTransfer.monto)
                    return alert("Complete todos los campos");

                TransferenciaAPI.realizar(this.formTransfer)
                    .then(res => this.resultadoTransferencia = res.body)
                    .catch(() => alert("Error procesando transferencia"));
            },

            // 2) Historial
            ejecutarHistorial() {
                if (!this.inputs.idUsuarioHistorial)
                    return alert("Ingrese el ID Usuario");

                TransferenciaAPI.historial(
                    this.inputs.idUsuarioHistorial,
                    this.inputs.fechaHistorial,
                    this.inputs.montoHistorial
                )
                .then(res => this.listaHistorial = res.body)
                .catch(() => alert("Error consultando historial"));
            }
        }
    });
</script>
